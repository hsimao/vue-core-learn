<script src="https://unpkg.com/vue@next"></script>

<div id="app"></div>

<script>
  const { createApp, ref, watchEffect } = Vue;

  function usePost(getId) {
    return useFetch(
      () => `https://jsonplaceholder.typicode.com/todos/${getId()}`
    );
  }

  // 使用 function 來接收 props 異動參數後的新網址, 才能監聽到新的 props 異動
  function useFetch(getUrl) {
    const data = ref(null);
    const error = ref(null);
    const isPending = ref(true);

    function init() {
      isPending.value = true;
      data.value = null;
      error.value = null;
    }

    watchEffect(() => {
      init();

      fetch(getUrl())
        .then((res) => res.json())
        .then((_data) => {
          setTimeout(() => {
            data.value = _data;
            isPending.value = false;
          }, 1000);
        })
        .catch((err) => {
          error.value = err;
          isPending.value = false;
        });
    });

    return {
      data,
      error,
      isPending
    };
  }

  const Post = {
    props: ["id"],
    template: `
      <div v-if="isPending">loading...</div>
      <div v-else-if="data">{{ data }}</div>
      <div v-else-if="error">Something went wrong: {{ error.message }}</div>
    `,
    setup(props) {
      // 使用傳遞 funciton 給 useHooks, 可維持 props.id 響應後通知到 useFetch 內的 watchEffect
      const { data, error, isPending } = usePost(() => props.id);

      return {
        data,
        error,
        isPending
      };
    }
  };

  const App = {
    components: { Post },
    template: `
      <button @click="id++">change ID</button>
      <Post :id="id" />
    `,
    data() {
      return {
        id: 1
      };
    }
  };

  createApp(App).mount("#app");
</script>
